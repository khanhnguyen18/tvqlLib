<?xml version="1.0" encoding="utf-8" ?>
<?xml-stylesheet type='text/xsl' href="scriptsql.xsl"?>
<root xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
<database includeDrop="true">LibraryManagement</database>
<procedures>
		
		<procedure owner="dbo" name="Book_Get_List" >
			<comment><![CDATA[/*
----------------------------------------------------------------------------------------------------

-- Created By:  ()
-- Purpose: Gets all records from the Book table
----------------------------------------------------------------------------------------------------
*/
]]></comment>
			<parameters/>
			<body><![CDATA[
				
				SELECT
					[BookId],
					[BookCode],
					[BookName],
					[Author],
					[PublisherId],
					[BookCategoryId],
					[YearPublisher],
					[Quantity],
					[Description]
				FROM
					[dbo].[Book]
					
				SELECT @@ROWCOUNT
			]]></body>
		</procedure>
		
		
		<procedure owner="dbo" name="Book_GetPaged" >
			<comment><![CDATA[/*
----------------------------------------------------------------------------------------------------

-- Created By:  ()
-- Purpose: Gets records from the Book table passing page index and page count parameters
----------------------------------------------------------------------------------------------------
*/
]]></comment>
			<parameters>
				<parameter name="@WhereClause" type="varchar" direction="Input" size="8000" precision="0" scale="0" param="(8000)" />
				<parameter name="@OrderBy" type="varchar" direction="Input" size="2000" precision="0" scale="0" param="(2000)"/>
				<parameter name="@PageIndex" type="int" direction="Input" size="0" precision="10" scale="0" />
				<parameter name="@PageSize" type="int" direction="Input" size="0" precision="10" scale="0" /> 
			</parameters>
			<body><![CDATA[
				
				BEGIN
				DECLARE @PageLowerBound int
				DECLARE @PageUpperBound int
				
				-- Set the page bounds
				SET @PageLowerBound = @PageSize * @PageIndex
				SET @PageUpperBound = @PageLowerBound + @PageSize

				-- Create a temp table to store the select results
				CREATE TABLE #PageIndex
				(
				    [IndexId] int IDENTITY (1, 1) NOT NULL,
				    [BookId] bigint 
				)
				
				-- Insert into the temp table
				DECLARE @SQL AS nvarchar(4000)
				SET @SQL = 'INSERT INTO #PageIndex ([BookId])'
				SET @SQL = @SQL + ' SELECT'
				SET @SQL = @SQL + ' [BookId]'
				SET @SQL = @SQL + ' FROM [dbo].[Book]'
				IF LEN(@WhereClause) > 0
				BEGIN
					SET @SQL = @SQL + ' WHERE ' + @WhereClause
				END
				IF LEN(@OrderBy) > 0
				BEGIN
					SET @SQL = @SQL + ' ORDER BY ' + @OrderBy
				END
				
				-- Only get the number of rows needed here.
				SET ROWCOUNT @PageUpperBound
				
				-- Populate the temp table
				EXEC sp_executesql @SQL

				-- Reset Rowcount back to all
				SET ROWCOUNT 0
				
				-- Return paged results
				SELECT O.[BookId], O.[BookCode], O.[BookName], O.[Author], O.[PublisherId], O.[BookCategoryId], O.[YearPublisher], O.[Quantity], O.[Description]
				FROM
				    [dbo].[Book] O,
				    #PageIndex PageIndex
				WHERE
				    PageIndex.IndexId > @PageLowerBound
					AND O.[BookId] = PageIndex.[BookId]
				ORDER BY
				    PageIndex.IndexId
                
				-- get row count
				SET @SQL = 'SELECT COUNT(1) AS TotalRowCount'
				SET @SQL = @SQL + ' FROM [dbo].[Book]'
				IF LEN(@WhereClause) > 0
				BEGIN
					SET @SQL = @SQL + ' WHERE ' + @WhereClause
				END
				EXEC sp_executesql @SQL
			
				END
			]]></body>
		</procedure>
		
		<procedure owner="dbo" name="Book_Insert" grant="">
			<comment><![CDATA[/*
----------------------------------------------------------------------------------------------------

-- Created By:  ()
-- Purpose: Inserts a record into the Book table
----------------------------------------------------------------------------------------------------
*/
]]></comment>
			<parameters>
				<parameter name="@BookId" type="bigint" direction="Output" size="8" precision="19" scale="0" param="" nulldefault=""/>
				<parameter name="@BookCode" type="nvarchar" direction="Input" size="50" precision="0" scale="0" param="(50)" nulldefault=""/>
				<parameter name="@BookName" type="nvarchar" direction="Input" size="1000" precision="0" scale="0" param="(1000)" nulldefault=""/>
				<parameter name="@Author" type="nvarchar" direction="Input" size="2000" precision="0" scale="0" param="(2000)" nulldefault=""/>
				<parameter name="@PublisherId" type="char" direction="Input" size="9" precision="0" scale="0" param="(9)" nulldefault=""/>
				<parameter name="@BookCategoryId" type="char" direction="Input" size="10" precision="0" scale="0" param="(10)" nulldefault=""/>
				<parameter name="@YearPublisher" type="varchar" direction="Input" size="4" precision="0" scale="0" param="(4)" nulldefault=""/>
				<parameter name="@Quantity" type="int" direction="Input" size="4" precision="10" scale="0" param="" nulldefault=""/>
				<parameter name="@Description" type="nvarchar" direction="Input" size="4000" precision="0" scale="0" param="(4000)" nulldefault=""/>
			</parameters>
			<body><![CDATA[
				
				INSERT INTO [dbo].[Book]
					(
					[BookCode]
					,[BookName]
					,[Author]
					,[PublisherId]
					,[BookCategoryId]
					,[YearPublisher]
					,[Quantity]
					,[Description]
					)
				VALUES
					(
					@BookCode
					,@BookName
					,@Author
					,@PublisherId
					,@BookCategoryId
					,@YearPublisher
					,@Quantity
					,@Description
					)
				-- Get the identity value
				SET @BookId = SCOPE_IDENTITY()
									
							
			]]></body>
		</procedure>
		<procedure owner="dbo" name="Book_Update" grant="">
			<comment><![CDATA[/*
----------------------------------------------------------------------------------------------------

-- Created By:  ()
-- Purpose: Updates a record in the Book table
----------------------------------------------------------------------------------------------------
*/
]]></comment>
			<parameters>
				<parameter name="@BookId" type="bigint" direction="Input" size="8" precision="19" scale="0" param="" nulldefault=""/>
				<parameter name="@BookCode" type="nvarchar" direction="Input" size="50" precision="0" scale="0" param="(50)" nulldefault=""/>
				<parameter name="@BookName" type="nvarchar" direction="Input" size="1000" precision="0" scale="0" param="(1000)" nulldefault=""/>
				<parameter name="@Author" type="nvarchar" direction="Input" size="2000" precision="0" scale="0" param="(2000)" nulldefault=""/>
				<parameter name="@PublisherId" type="char" direction="Input" size="9" precision="0" scale="0" param="(9)" nulldefault=""/>
				<parameter name="@BookCategoryId" type="char" direction="Input" size="10" precision="0" scale="0" param="(10)" nulldefault=""/>
				<parameter name="@YearPublisher" type="varchar" direction="Input" size="4" precision="0" scale="0" param="(4)" nulldefault=""/>
				<parameter name="@Quantity" type="int" direction="Input" size="4" precision="10" scale="0" param="" nulldefault=""/>
				<parameter name="@Description" type="nvarchar" direction="Input" size="4000" precision="0" scale="0" param="(4000)" nulldefault=""/>
			</parameters>
			<body><![CDATA[
				
				
				-- Modify the updatable columns
				UPDATE
					[dbo].[Book]
				SET
					[BookCode] = @BookCode
					,[BookName] = @BookName
					,[Author] = @Author
					,[PublisherId] = @PublisherId
					,[BookCategoryId] = @BookCategoryId
					,[YearPublisher] = @YearPublisher
					,[Quantity] = @Quantity
					,[Description] = @Description
				WHERE
[BookId] = @BookId 
				
			]]></body>
		</procedure>
		<procedure owner="dbo" name="Book_Delete" grant="">
			<comment><![CDATA[/*
----------------------------------------------------------------------------------------------------

-- Created By:  ()
-- Purpose: Deletes a record in the Book table
----------------------------------------------------------------------------------------------------
*/
]]></comment>
			<parameters>
				<parameter name="@BookId" type="bigint" direction="Input" size="8" precision="19" scale="0" param="" nulldefault=""/>
			</parameters>
			<body><![CDATA[
				DELETE FROM [dbo].[Book] WITH (ROWLOCK) 
				WHERE
					[BookId] = @BookId
					
			]]></body>
		</procedure>
		<procedure owner="dbo" name="Book_GetByBookId" >
			<comment><![CDATA[/*
----------------------------------------------------------------------------------------------------

-- Created By:  ()
-- Purpose: Select records from the Book table through an index
----------------------------------------------------------------------------------------------------
*/
]]></comment>
			<parameters>
				<parameter name="@BookId" type="bigint" direction="Input" size="8" precision="19" scale="0" param="" nulldefault=""/>
			</parameters>
			<body><![CDATA[
				SELECT
					[BookId],
					[BookCode],
					[BookName],
					[Author],
					[PublisherId],
					[BookCategoryId],
					[YearPublisher],
					[Quantity],
					[Description]
				FROM
					[dbo].[Book]
				WHERE
					[BookId] = @BookId
				SELECT @@ROWCOUNT
					
			]]></body>
			
		</procedure>
		<procedure owner="dbo" name="Book_Find" >
			<comment><![CDATA[/*
----------------------------------------------------------------------------------------------------

-- Created By:  ()
-- Purpose: Finds records in the Book table passing nullable parameters
----------------------------------------------------------------------------------------------------
*/
]]></comment>
			<parameters>
				<parameter name="@SearchUsingOR" type="bit" direction="Input" size="0" precision="1" scale="0" param="" nulldefault="null"/>
				<parameter name="@BookId" type="bigint" direction="Input" size="8" precision="19" scale="0" param="" nulldefault="null"/>
				<parameter name="@BookCode" type="nvarchar" direction="Input" size="50" precision="0" scale="0" param="(50)" nulldefault="null"/>
				<parameter name="@BookName" type="nvarchar" direction="Input" size="1000" precision="0" scale="0" param="(1000)" nulldefault="null"/>
				<parameter name="@Author" type="nvarchar" direction="Input" size="2000" precision="0" scale="0" param="(2000)" nulldefault="null"/>
				<parameter name="@PublisherId" type="char" direction="Input" size="9" precision="0" scale="0" param="(9)" nulldefault="null"/>
				<parameter name="@BookCategoryId" type="char" direction="Input" size="10" precision="0" scale="0" param="(10)" nulldefault="null"/>
				<parameter name="@YearPublisher" type="varchar" direction="Input" size="4" precision="0" scale="0" param="(4)" nulldefault="null"/>
				<parameter name="@Quantity" type="int" direction="Input" size="4" precision="10" scale="0" param="" nulldefault="null"/>
				<parameter name="@Description" type="nvarchar" direction="Input" size="4000" precision="0" scale="0" param="(4000)" nulldefault="null"/>
			</parameters>
			<body><![CDATA[
				
  IF ISNULL(@SearchUsingOR, 0) <> 1
  BEGIN
    SELECT
	  [BookId]
	, [BookCode]
	, [BookName]
	, [Author]
	, [PublisherId]
	, [BookCategoryId]
	, [YearPublisher]
	, [Quantity]
	, [Description]
    FROM
	[dbo].[Book]
    WHERE 
	 ([BookId] = @BookId OR @BookId IS NULL)
	AND ([BookCode] = @BookCode OR @BookCode IS NULL)
	AND ([BookName] = @BookName OR @BookName IS NULL)
	AND ([Author] = @Author OR @Author IS NULL)
	AND ([PublisherId] = @PublisherId OR @PublisherId IS NULL)
	AND ([BookCategoryId] = @BookCategoryId OR @BookCategoryId IS NULL)
	AND ([YearPublisher] = @YearPublisher OR @YearPublisher IS NULL)
	AND ([Quantity] = @Quantity OR @Quantity IS NULL)
	AND ([Description] = @Description OR @Description IS NULL)
						
  END
  ELSE
  BEGIN
    SELECT
	  [BookId]
	, [BookCode]
	, [BookName]
	, [Author]
	, [PublisherId]
	, [BookCategoryId]
	, [YearPublisher]
	, [Quantity]
	, [Description]
    FROM
	[dbo].[Book]
    WHERE 
	 ([BookId] = @BookId AND @BookId is not null)
	OR ([BookCode] = @BookCode AND @BookCode is not null)
	OR ([BookName] = @BookName AND @BookName is not null)
	OR ([Author] = @Author AND @Author is not null)
	OR ([PublisherId] = @PublisherId AND @PublisherId is not null)
	OR ([BookCategoryId] = @BookCategoryId AND @BookCategoryId is not null)
	OR ([YearPublisher] = @YearPublisher AND @YearPublisher is not null)
	OR ([Quantity] = @Quantity AND @Quantity is not null)
	OR ([Description] = @Description AND @Description is not null)
	SELECT @@ROWCOUNT			
  END
				]]></body>
		</procedure>

		
		<procedure owner="dbo" name="Book_Find_Dynamic"  skip="true">
			<comment><![CDATA[/*
----------------------------------------------------------------------------------------------------

-- Created By:  ()
-- Purpose: Gets records from the Book table using a dynamically generated query.
----------------------------------------------------------------------------------------------------
*/
]]></comment>
			<parameters/>
			<body><![CDATA[
				
				BEGIN
				
				-- Create a temp table to store the select results
				CREATE TABLE #PageIndex
				(
				    [IndexId] int IDENTITY (1, 1) NOT NULL,
				    [BookId] bigint 
				)
				
				-- Insert into the temp table
				INSERT INTO #PageIndex ( [BookId] )
				SELECT TOP {3} [BookId]
				FROM [dbo].[Book] {0}
				ORDER BY {1}
				
				-- Return paged results
				SELECT O.[BookId], O.[BookCode], O.[BookName], O.[Author], O.[PublisherId], O.[BookCategoryId], O.[YearPublisher], O.[Quantity], O.[Description]
				FROM
				    [dbo].[Book] O,
				    #PageIndex PageIndex
				WHERE
				    PageIndex.IndexId > {2}
				    AND O.[BookId] = PageIndex.[BookId]
				ORDER BY
				    PageIndex.IndexId
				

				-- get total count
				SELECT COUNT(*) AS TotalRowCount FROM [dbo].[Book] {0};
				
				DROP TABLE #PageIndex
				END
			]]></body>
		</procedure>
		
</procedures>
</root>
